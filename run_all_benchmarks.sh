#!/bin/bash

# Скрипт для последовательного запуска тестов для всех рантаймов
# Использование: ./run_all_benchmarks.sh [iterations]
# [iterations] - количество итераций для каждого рантайма (по умолчанию 3)

ITERATIONS=${1:-3}  # По умолчанию 3 итерации, если не указано иное
RUNTIMES=("node" "deno" "bun")

echo "Запуск бенчмарков для всех рантаймов с $ITERATIONS итерациями каждый"

# Запуск HTTP бенчмарков
echo "==============================================="
echo "Запуск HTTP бенчмарков"
echo "==============================================="

for runtime in "${RUNTIMES[@]}"; do
    echo "-----------------------------------------------"
    echo "Запуск HTTP бенчмарка для $runtime ($ITERATIONS итераций)..."
    echo "-----------------------------------------------"
    
    ./benchmark_http.sh "$runtime" "$ITERATIONS"
    
    # Проверка кода возврата
    if [ $? -ne 0 ]; then
        echo "ОШИБКА: HTTP бенчмарк для $runtime завершился с ошибкой!"
    else
        echo "HTTP бенчмарк для $runtime успешно завершен."
    fi
    
    echo ""
    echo "Ожидание 10 секунд перед запуском следующего теста..."
    sleep 10
done

# Запуск асинхронных бенчмарков
echo "==============================================="
echo "Запуск асинхронных бенчмарков"
echo "==============================================="

for runtime in "${RUNTIMES[@]}"; do
    echo "-----------------------------------------------"
    echo "Запуск асинхронного бенчмарка для $runtime ($ITERATIONS итераций)..."
    echo "-----------------------------------------------"
    
    ./benchmark_async.sh "$runtime" "$ITERATIONS"
    
    # Проверка кода возврата
    if [ $? -ne 0 ]; then
        echo "ОШИБКА: Асинхронный бенчмарк для $runtime завершился с ошибкой!"
    else
        echo "Асинхронный бенчмарк для $runtime успешно завершен."
    fi
    
    echo ""
    echo "Ожидание 10 секунд перед запуском следующего теста..."
    sleep 10
done

echo "==============================================="
echo "Все тесты завершены! Результаты находятся в директории ./results/"
echo "===============================================" 